<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <title>AI To-Do List</title>
    <link
      rel="stylesheet"
      href="{{ url_for('static', filename='style.css') }}"
    />
  </head>
  <body>
    <div class="container">
      <!-- ------------------- Task Manager Panel ------------------- -->
      <div class="tasks-panel">
        <h2>Task Manager</h2>

        <!-- Search and Filters -->
        <div class="task-controls">
          <input
            type="text"
            id="search-task"
            placeholder="Search tasks..."
            oninput="renderTasks()"
          />
          <select id="filter-task" onchange="renderTasks()">
            <option value="all">All</option>
            <option value="pending">Pending</option>
            <option value="completed">Completed</option>
          </select>
          <select id="sort-task" onchange="renderTasks()">
            <option value="newest">Newest</option>
            <option value="oldest">Oldest</option>
            <option value="alphabetical">A â†’ Z</option>
          </select>
        </div>

        <ul id="task-list"></ul>

        <div class="add-task">
          <input type="text" id="new-task" placeholder="New task..." />
          <button onclick="addTask()">Add Task</button>
        </div>
      </div>

      <!-- ------------------- AI Assistant Panel ------------------- -->
      <div class="chat-panel">
        <h2>AI Assistant</h2>
        <div id="chat-box"></div>
        <div class="chat-input">
          <input type="text" id="user-input" placeholder="Talk to AI..." />
          <button onclick="sendMessage()">Send</button>
        </div>
      </div>
    </div>

    <!-- ------------------- Script ------------------- -->
    <script>
      let tasksCache = [];

      async function loadTasks() {
        const res = await fetch("/tasks");
        tasksCache = await res.json();
        renderTasks();
      }

      function renderTasks() {
        const list = document.getElementById("task-list");
        list.innerHTML = "";

        const search = document
          .getElementById("search-task")
          .value.toLowerCase();
        const filter = document.getElementById("filter-task").value;
        const sort = document.getElementById("sort-task").value;

        let tasks = [...tasksCache];

        // Filter
        if (filter === "pending") tasks = tasks.filter((t) => !t.completed);
        if (filter === "completed") tasks = tasks.filter((t) => t.completed);

        // Search
        if (search)
          tasks = tasks.filter((t) =>
            t.description.toLowerCase().includes(search)
          );

        // Sort
        if (sort === "newest") tasks.sort((a, b) => b.id - a.id);
        if (sort === "oldest") tasks.sort((a, b) => a.id - b.id);
        if (sort === "alphabetical")
          tasks.sort((a, b) => a.description.localeCompare(b.description));

        // Render
        tasks.forEach((t) => {
          const li = document.createElement("li");
          const desc = document.createElement("span");
          desc.textContent = t.description;
          desc.style.textDecoration = t.completed ? "line-through" : "none";
          li.appendChild(desc);

          const completeBtn = document.createElement("button");
          completeBtn.textContent = "âœ…";
          completeBtn.onclick = () => completeTask(t.id);
          li.appendChild(completeBtn);

          const deleteBtn = document.createElement("button");
          deleteBtn.textContent = "ðŸ—‘";
          deleteBtn.onclick = () => deleteTask(t.id);
          li.appendChild(deleteBtn);

          list.appendChild(li);
        });
      }

      async function addTask() {
        const desc = document.getElementById("new-task").value;
        if (!desc) return;
        await fetch("/tasks", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ description: desc }),
        });
        document.getElementById("new-task").value = "";
        await loadTasks();
      }

      async function completeTask(id) {
        await fetch(`/tasks/${id}/complete`, { method: "PUT" });
        await loadTasks();
      }

      async function deleteTask(id) {
        await fetch(`/tasks/${id}`, { method: "DELETE" });
        await loadTasks();
      }

      async function addTaskFromAI(desc) {
        await fetch("/tasks", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ description: desc }),
        });
        await loadTasks();
      }

      async function sendMessage() {
        const text = document.getElementById("user-input").value;
        if (!text) return;
        const chatBox = document.getElementById("chat-box");
        chatBox.innerHTML += `<div class="user">You: ${text}</div>`;

        const res = await fetch("/ai", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ user_text: text }),
        });

        const data = await res.json();

        let parsed = null;
        try {
          parsed = JSON.parse(data.ai_response);
        } catch {}

        if (parsed && parsed.function) {
          const desc = parsed.parameters?.description;
          let task = tasksCache.find(
            (t) => t.description.toLowerCase() === desc?.toLowerCase()
          );

          if (parsed.function === "addTask") await addTaskFromAI(desc);
          else if (parsed.function === "completeTask" && task)
            await completeTask(task.id);
          else if (parsed.function === "deleteTask" && task)
            await deleteTask(task.id);
          else if (parsed.function === "viewTasks") await loadTasks();

          chatBox.innerHTML += `<div class="ai">AI executed: ${parsed.function}</div>`;
        } else {
          chatBox.innerHTML += `<div class="ai">AI: ${data.ai_response}</div>`;
        }

        document.getElementById("user-input").value = "";
        chatBox.scrollTo({ top: chatBox.scrollHeight, behavior: "smooth" });
      }

      window.onload = loadTasks;
    </script>
  </body>
</html>
